<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>五运六气 AHI 健康 K 线图</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Noto+Serif+SC:wght@400;700&family=JetBrains+Mono&display=swap');
        
        :root {
            --bg-main: #0a0a0c;
            --card-bg: #141417;
            --border-color: rgba(255, 255, 255, 0.08);
            --accent-green: #2ca02c;
            --accent-red: #d62728;
            --text-primary: #f0f0f2;
            --text-secondary: #94949e;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            background-image: radial-gradient(circle at 50% -20%, #1a1a2e 0%, transparent 70%);
        }

        .serif { font-family: 'Noto Serif SC', serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }

        .glass-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 1.25rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            transition: transform 0.3s ease, border-color 0.3s ease;
        }

        .input-select {
            background-color: #1c1c21;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394949e'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1rem;
        }

        .input-select:focus {
            border-color: #4a4a5e;
            outline: none;
        }

        .btn-generate {
            background: linear-gradient(135deg, #238636 0%, #2ea043 100%);
            box-shadow: 0 4px 12px rgba(35, 134, 54, 0.3);
            transition: all 0.2s ease;
        }

        .btn-generate:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(35, 134, 54, 0.4);
        }

        .summary-badge {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            padding: 0.75rem;
            border-radius: 0.75rem;
        }

        .status-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.02) 0%, rgba(255,255,255,0) 100%);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-10">
    <div class="max-w-7xl mx-auto">
        <header class="mb-12 text-center">
            <h1 class="text-4xl md:text-5xl font-bold text-white mb-4 tracking-tight serif">五运六气健康分析系统</h1>
            <div class="flex flex-col items-center">
                <p class="text-lg text-gray-400 max-w-2xl leading-relaxed">
                    基于传统中医运气学说的年度天人和谐健康指数<br>
                    <span class="text-sm opacity-60 font-light tracking-widest uppercase mt-1 block">Annual Harmony Index (AHI)</span>
                </p>
                <div class="h-1 w-20 bg-emerald-500 mt-6 rounded-full opacity-50"></div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Left: Controls & Summary -->
            <div class="lg:col-span-4 space-y-6">
                <div class="glass-card p-8">
                    <h2 class="text-xl font-semibold text-white mb-8 flex items-center serif">
                        <span class="w-8 h-8 rounded-full bg-emerald-500/10 text-emerald-500 flex items-center justify-center mr-3 text-sm">01</span>
                        先天排盘
                    </h2>
                    <form id="calcForm" class="space-y-6">
                        <div class="grid grid-cols-3 gap-3">
                            <div class="col-span-1">
                                <label class="block text-xs text-gray-500 mb-2 uppercase tracking-wider">出生年份</label>
                                <select id="birthYear" class="w-full p-3 input-select rounded-xl text-sm"></select>
                            </div>
                            <div class="col-span-1">
                                <label class="block text-xs text-gray-500 mb-2 uppercase tracking-wider">月份</label>
                                <select id="birthMonth" class="w-full p-3 input-select rounded-xl text-sm"></select>
                            </div>
                            <div class="col-span-1">
                                <label class="block text-xs text-gray-500 mb-2 uppercase tracking-wider">日期</label>
                                <select id="birthDay" class="w-full p-3 input-select rounded-xl text-sm"></select>
                            </div>
                        </div>
                        <button type="submit" class="w-full py-4 px-6 rounded-xl font-bold btn-generate text-white flex items-center justify-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            <span>生成健康 K 线图</span>
                        </button>
                    </form>
                </div>

                <div id="summarySection" class="hidden space-y-4 animate-in fade-in slide-in-from-bottom-4 duration-700">
                    <div class="glass-card p-8">
                        <h2 class="text-xl font-semibold text-white mb-6 flex items-center serif">
                            <span class="w-8 h-8 rounded-full bg-blue-500/10 text-blue-500 flex items-center justify-center mr-3 text-sm">02</span>
                            运气概要
                        </h2>
                        
                        <div class="grid grid-cols-2 gap-3 mb-6">
                            <div class="summary-badge">
                                <p class="text-[10px] text-gray-500 uppercase mb-1">干支纪年</p>
                                <p id="summary-ganzhi" class="text-sm font-bold text-blue-400 mono"></p>
                            </div>
                            <div class="summary-badge">
                                <p class="text-[10px] text-gray-500 uppercase mb-1">岁运</p>
                                <p id="summary-suiyun" class="text-sm font-bold text-emerald-400"></p>
                            </div>
                            <div class="summary-badge">
                                <p class="text-[10px] text-gray-500 uppercase mb-1">司天</p>
                                <p id="summary-sitian" class="text-sm font-bold text-orange-400"></p>
                            </div>
                            <div class="summary-badge">
                                <p class="text-[10px] text-gray-500 uppercase mb-1">在泉</p>
                                <p id="summary-zaiquan" class="text-sm font-bold text-purple-400"></p>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div class="status-card p-4">
                                <div class="flex items-center mb-2">
                                    <div class="w-2 h-2 rounded-full bg-emerald-500 mr-2"></div>
                                    <span class="text-xs text-gray-400">当日五运格局</span>
                                </div>
                                <p id="summary-fortune" class="text-sm text-gray-200 leading-relaxed"></p>
                            </div>
                            <div class="status-card p-4">
                                <div class="flex items-center mb-2">
                                    <div class="w-2 h-2 rounded-full bg-blue-500 mr-2"></div>
                                    <span class="text-xs text-gray-400">当日六气格局</span>
                                </div>
                                <p id="summary-qi" class="text-sm text-gray-200 leading-relaxed"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Chart Display -->
            <div class="lg:col-span-8">
                <div class="glass-card p-8 h-full flex flex-col relative overflow-hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-white serif">AHI 天人和谐动态趋势</h2>
                            <p class="text-sm text-gray-500 mt-1">0-60岁全生命周期健康指数 K 线分析</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div id="baseScoreBadge" class="hidden px-4 py-2 rounded-xl bg-white/5 border border-white/10 text-xs">
                                <span class="text-gray-500">先天基准:</span>
                                <span id="baseScoreValue" class="text-emerald-400 font-bold ml-1 mono">--</span>
                            </div>
                            <button id="saveImgBtn" class="hidden p-2 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 transition-colors" title="保存为图片">
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            </button>
                        </div>
                    </div>

                    <div id="chartContainer" class="flex-grow w-full min-h-[500px]"></div>
                    
                    <div id="chartPlaceholder" class="absolute inset-0 flex flex-col items-center justify-center bg-[#141417] z-10">
                        <div class="w-24 h-24 rounded-full bg-emerald-500/5 flex items-center justify-center mb-6">
                            <svg class="w-10 h-10 text-emerald-500/40" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        </div>
                        <p class="text-gray-500 text-lg serif">待命 · 请在左侧输入出生日期</p>
                        <p class="text-gray-600 text-sm mt-2">系统将为您演算六十载运气碰撞</p>
                    </div>

                    <!-- Legend -->
                    <div class="mt-6 flex items-center justify-center space-x-8 text-[10px] text-gray-500 uppercase tracking-widest">
                        <div class="flex items-center"><div class="w-3 h-3 bg-[#2ca02c] rounded-sm mr-2"></div> 气场升华 (AHI 增长)</div>
                        <div class="flex items-center"><div class="w-3 h-3 bg-[#d62728] rounded-sm mr-2"></div> 气场损耗 (AHI 下降)</div>
                        <div class="flex items-center"><div class="w-6 h-0 border-t border-dashed border-gray-600 mr-2"></div> 先天基准线</div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="mt-16 text-center">
            <p class="text-gray-600 text-xs tracking-widest uppercase">© 2026 五运六气健康分析系统 · 仅供学术研究参考</p>
        </footer>
    </div>

    <script>
        const form = document.getElementById('calcForm');
        const chartContainer = document.getElementById('chartContainer');
        const chartPlaceholder = document.getElementById('chartPlaceholder');
        const summarySection = document.getElementById('summarySection');
        const baseScoreBadge = document.getElementById('baseScoreBadge');
        const saveImgBtn = document.getElementById('saveImgBtn');
        
        const yearSelect = document.getElementById('birthYear');
        const monthSelect = document.getElementById('birthMonth');
        const daySelect = document.getElementById('birthDay');

        // Initialize Selects
        const currentYear = new Date().getFullYear();
        for (let y = currentYear; y >= 1900; y--) {
            const opt = document.createElement('option');
            opt.value = y; opt.textContent = y;
            yearSelect.appendChild(opt);
        }
        for (let m = 1; m <= 12; m++) {
            const opt = document.createElement('option');
            opt.value = m; opt.textContent = m;
            monthSelect.appendChild(opt);
        }
        function updateDays() {
            const y = parseInt(yearSelect.value);
            const m = parseInt(monthSelect.value);
            const daysInMonth = new Date(y, m, 0).getDate();
            const currentVal = daySelect.value;
            daySelect.innerHTML = '';
            for (let d = 1; d <= daysInMonth; d++) {
                const opt = document.createElement('option');
                opt.value = d; opt.textContent = d;
                daySelect.appendChild(opt);
            }
            if (currentVal && currentVal <= daysInMonth) daySelect.value = currentVal;
        }
        yearSelect.addEventListener('change', updateDays);
        monthSelect.addEventListener('change', updateDays);
        updateDays();
        yearSelect.value = 1990;
        monthSelect.value = 1;
        daySelect.value = 1;

        let myChart = null;

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const year = parseInt(yearSelect.value);
            const month = parseInt(monthSelect.value);
            const day = parseInt(daySelect.value);

            try {
                const response = await fetch('/api/calculate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ year, month, day })
                });

                if (!response.ok) throw new Error('计算失败');

                const data = await response.json();
                updateUI(data);
            } catch (error) {
                alert(error.message);
            }
        });

        saveImgBtn.addEventListener('click', () => {
            if (myChart) {
                const url = myChart.getDataURL({
                    type: 'png',
                    pixelRatio: 2,
                    backgroundColor: '#141417'
                });
                const link = document.createElement('a');
                link.download = 'AHI_Health_Chart.png';
                link.href = url;
                link.click();
            }
        });

        function updateUI(data) {
            document.getElementById('summary-ganzhi').textContent = data.wylq_summary.ganzhi;
            document.getElementById('summary-suiyun').textContent = data.wylq_summary.suiyun;
            document.getElementById('summary-sitian').textContent = data.wylq_summary.sitian;
            document.getElementById('summary-zaiquan').textContent = data.wylq_summary.zaiquan;
            document.getElementById('summary-fortune').textContent = data.wylq_summary.current_fortune;
            document.getElementById('summary-qi').textContent = data.wylq_summary.current_qi;
            
            summarySection.classList.remove('hidden');
            document.getElementById('baseScoreValue').textContent = data.base_score.toFixed(1);
            baseScoreBadge.classList.remove('hidden');
            saveImgBtn.classList.remove('hidden');
            chartPlaceholder.classList.add('hidden');
            renderChart(data.kline_data, data.base_score);
        }

        function renderChart(klineData, baseScore) {
            if (!myChart) {
                myChart = echarts.init(chartContainer);
            }

            const ages = klineData.map(d => d.age);
            const values = klineData.map(d => [d.open, d.close, d.open, d.close]);

            const option = {
                backgroundColor: 'transparent',
                animationDuration: 2000,
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross', lineStyle: { color: 'rgba(255,255,255,0.1)' } },
                    backgroundColor: '#1c1c21',
                    borderColor: 'rgba(255,255,255,0.1)',
                    padding: 12,
                    textStyle: { color: '#f0f0f2', fontSize: 12 },
                    formatter: function (params) {
                        const data = params[0];
                        const age = data.name;
                        const open = data.value[1];
                        const close = data.value[2];
                        const diff = (close - open).toFixed(2);
                        const color = close >= open ? '#2ca02c' : '#d62728';
                        return `
                            <div style="font-family: 'Inter', sans-serif;">
                                <div style="font-weight: 600; margin-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 4px;">年龄: ${age} 岁</div>
                                <div style="display: flex; justify-content: space-between; gap: 20px; margin-bottom: 4px;">
                                    <span style="color: #94949e">开盘指数</span>
                                    <span style="font-family: 'JetBrains Mono'">${open}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; gap: 20px; margin-bottom: 4px;">
                                    <span style="color: #94949e">收盘指数</span>
                                    <span style="font-family: 'JetBrains Mono'">${close}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; gap: 20px;">
                                    <span style="color: #94949e">年度变动</span>
                                    <span style="font-family: 'JetBrains Mono'; color: ${color}">${diff > 0 ? '+' : ''}${diff}</span>
                                </div>
                            </div>
                        `;
                    }
                },
                grid: { left: '4%', right: '4%', bottom: '8%', top: '8%', containLabel: true },
                xAxis: {
                    type: 'category',
                    data: ages,
                    axisLine: { lineStyle: { color: 'rgba(255,255,255,0.1)' } },
                    axisLabel: { color: '#666', fontSize: 10 },
                    axisTick: { show: false }
                },
                yAxis: {
                    scale: true,
                    min: 0,
                    max: 100,
                    axisLine: { show: false },
                    axisLabel: { color: '#666', fontSize: 10 },
                    splitLine: { lineStyle: { color: 'rgba(255,255,255,0.03)' } }
                },
                series: [
                    {
                        type: 'candlestick',
                        data: values,
                        itemStyle: {
                            color: '#2ca02c',
                            color0: '#d62728',
                            borderColor: '#2ca02c',
                            borderColor0: '#d62728',
                            borderWidth: 1
                        },
                        markLine: {
                            symbol: ['none', 'none'],
                            data: [
                                {
                                    yAxis: baseScore,
                                    lineStyle: { color: 'rgba(255,255,255,0.2)', type: 'dashed' },
                                    label: { show: false }
                                }
                            ]
                        }
                    }
                ]
            };
            myChart.setOption(option);
            window.addEventListener('resize', () => myChart.resize());
        }
    </script>
</body>
</html>
