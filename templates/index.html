<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>人生健康K线推演</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
</head>
<body class="bg-[#121212] text-gray-200 p-4 md:p-8 font-sans">
    <div class="max-w-4xl mx-auto space-y-6">
        
        <div class="bg-[#1e1e1e] p-6 rounded-2xl shadow-lg border border-gray-700">
            <h1 class="text-2xl font-bold text-white mb-6">🔮 中医运气健康 K 线推演</h1>
            <div class="flex gap-4 mb-6">
                <input type="number" id="year" placeholder="年 (例:1998)" class="flex-1 bg-gray-800 text-white rounded-lg p-3 border border-gray-600 focus:border-green-500 focus:ring-1 focus:ring-green-500 outline-none" value="1998">
                <input type="number" id="month" placeholder="月" class="flex-1 bg-gray-800 text-white rounded-lg p-3 border border-gray-600 focus:border-green-500 focus:ring-1 focus:ring-green-500 outline-none" value="2">
                <input type="number" id="day" placeholder="日" class="flex-1 bg-gray-800 text-white rounded-lg p-3 border border-gray-600 focus:border-green-500 focus:ring-1 focus:ring-green-500 outline-none" value="11">
            </div>
            <button id="submitBtn" onclick="calculateData()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-4 rounded-xl transition-colors duration-200">
                ⚡ 生成人生健康 K 线图
            </button>
        </div>

        <div id="loading" class="hidden text-center py-10 bg-[#1e1e1e] rounded-2xl border border-gray-700">
            <svg class="animate-spin h-10 w-10 text-green-500 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p class="text-gray-300 font-medium text-lg">正在推演流年碰撞，并呼叫千问老中医写报告...</p>
            <p class="text-gray-500 text-sm mt-2">（AI 思考约需 15-20 秒，请耐心等待）</p>
        </div>

        <div id="resultBox" class="hidden space-y-6">
            
            <div class="bg-[#1e1e1e] p-6 rounded-2xl border border-gray-700">
                <h2 class="text-xl font-bold text-white mb-4"><span class="text-blue-400 mr-2">01</span>运气概要</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-800 p-4 rounded-xl border border-gray-700"><p class="text-gray-400 text-sm">干支纪年</p><p id="v-gz" class="text-lg font-bold text-blue-300"></p></div>
                    <div class="bg-gray-800 p-4 rounded-xl border border-gray-700"><p class="text-gray-400 text-sm">岁运</p><p id="v-suiyun" class="text-lg font-bold text-green-400"></p></div>
                    <div class="bg-gray-800 p-4 rounded-xl border border-gray-700"><p class="text-gray-400 text-sm">司天</p><p id="v-sitian" class="text-lg font-bold text-orange-400"></p></div>
                    <div class="bg-gray-800 p-4 rounded-xl border border-gray-700"><p class="text-gray-400 text-sm">在泉</p><p id="v-zaiquan" class="text-lg font-bold text-purple-400"></p></div>
                </div>
                <div class="mt-4 space-y-3">
                    <div class="bg-gray-800 p-4 rounded-xl border border-gray-700"><p class="text-gray-400 text-sm">当日五运格局</p><p id="v-wuyun" class="text-md text-white"></p></div>
                    <div class="bg-gray-800 p-4 rounded-xl border border-gray-700"><p class="text-gray-400 text-sm">当日六气格局</p><p id="v-liuqi" class="text-md text-white"></p></div>
                </div>
            </div>

            <div class="bg-[#1e1e1e] p-6 rounded-2xl border border-gray-700">
                <h2 class="text-xl font-bold text-white mb-2"><span class="text-green-400 mr-2">02</span>AHI 天人和谐动态趋势</h2>
                <p class="text-gray-400 text-sm mb-4">0-60岁全生命周期健康指数 K 线分析</p>
                <div id="klineChart" class="w-full h-[400px]"></div>
            </div>

            <div class="bg-[#1e1e1e] p-6 rounded-2xl border border-gray-700">
                <h2 class="text-xl font-bold text-white mb-4"><span class="text-purple-400 mr-2">03</span>千问老中医专属健康报告</h2>
                <div class="bg-gray-800 p-5 rounded-xl border border-gray-700">
                    <p id="v-report" class="text-gray-300 leading-relaxed whitespace-pre-wrap"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function calculateData() {
            const btn = document.getElementById('submitBtn');
            const loading = document.getElementById('loading');
            const resultBox = document.getElementById('resultBox');

            // 按钮防抖与显示加载
            btn.disabled = true;
            btn.classList.replace('bg-green-600', 'bg-gray-600');
            loading.classList.remove('hidden');
            resultBox.classList.add('hidden');

            try {
                const response = await fetch('/api/calculate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        year: document.getElementById('year').value,
                        month: document.getElementById('month').value,
                        day: document.getElementById('day').value
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    // 绑定五运六气数据 (再也不会有包裹解不开的Bug了)
                    document.getElementById('v-gz').innerText = data.wylq.gz;
                    document.getElementById('v-suiyun').innerText = data.wylq.suiyun;
                    document.getElementById('v-sitian').innerText = data.wylq.sitian;
                    document.getElementById('v-zaiquan').innerText = data.wylq.zaiquan;
                    document.getElementById('v-wuyun').innerText = data.wylq.wuyun;
                    document.getElementById('v-liuqi').innerText = data.wylq.liuqi;
                    
                    // 绑定 AI 报告
                    document.getElementById('v-report').innerText = data.ai_report;

                    // 显示结果区域
                    resultBox.classList.remove('hidden');

                    // 绘制优雅的 K线图
                    drawChart(data.kline);
                } else {
                    alert("⚠️ 后端计算出错: " + data.message);
                }
            } catch (error) {
                alert("⚠️ 网络请求失败！如果你在 Render 上部署，请确认你已经按照指示，在 Render的 Settings 里加了 '--timeout 120' 的防超时配置！");
            } finally {
                btn.disabled = false;
                btn.classList.replace('bg-gray-600', 'bg-green-600');
                loading.classList.add('hidden');
            }
        }

        function drawChart(kline) {
            const chartDom = document.getElementById('klineChart');
            // 如果已存在实例先销毁，防止重复画图重叠
            let myChart = echarts.getInstanceByDom(chartDom);
            if (myChart) myChart.dispose();
            myChart = echarts.init(chartDom, 'dark');

            // 把后端传来的开盘收盘数据转换成 ECharts 的格式: [open, close, min, max]
            // 为了美观，我们的柱子没有上下影线，所以 min和max 就用最低和最高值
            const chartData = kline.ages.map((age, i) => {
                let o = kline.opens[i], c = kline.closes[i];
                if (Math.abs(o - c) < 0.5) c = o + 0.5; // 如果没涨跌，画个横线
                return [o, c, Math.min(o,c), Math.max(o,c)];
            });

            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' },
                    formatter: function (params) {
                        let data = params[0].data;
                        let color = data[2] > data[1] ? '#ef4444' : '#22c55e'; // 红降绿升
                        return `年龄: ${params[0].axisValue}岁<br/>
                                年初状态: <span style="color:${color}">${data[1].toFixed(1)} 分</span><br/>
                                年终状态: <span style="color:${color}">${data[2].toFixed(1)} 分</span>`;
                    }
                },
                grid: { left: '3%', right: '3%', bottom: '10%', top: '5%', containLabel: true },
                xAxis: {
                    type: 'category',
                    data: kline.ages,
                    axisLine: { lineStyle: { color: '#4b5563' } }
                },
                yAxis: {
                    type: 'value',
                    min: 0,
                    max: 100,
                    splitLine: { lineStyle: { color: '#374151', type: 'dashed' } }
                },
                series: [{
                    type: 'candlestick',
                    data: chartData,
                    itemStyle: {
                        color: '#22c55e',       // 阳线(涨)颜色：绿色
                        color0: '#ef4444',      // 阴线(跌)颜色：红色
                        borderColor: '#22c55e', 
                        borderColor0: '#ef4444'
                    },
                    markLine: {
                        silent: true,
                        data: [{ yAxis: kline.base_score, name: '个人基准分' }],
                        lineStyle: { color: '#9ca3af', type: 'dashed' },
                        label: { formatter: '先天基准: {c}' }
                    }
                }]
            };
            myChart.setOption(option);
            window.addEventListener('resize', () => myChart.resize());
        }
    </script>
</body>
</html>
